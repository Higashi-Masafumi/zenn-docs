---
title: 侵入検知
---

## TCP/IP 通信トラフィックの監視

[ethernet ポートミラーリング機能](https://zenn.dev/levtech/articles/homenetwork-ntopng)を使うことで、LAN からの外部への通信と、外部から LAN への通信をコピーして監視装置に流し込む

### 得られる IP パケットの情報

以下のコマンドで実際の IP パケットを確認することができます

```bash
sudo tcpdump -i any -v
```

IP パケットには主に以下の情報が含まれます。

- IP ヘッダー
  - IPsrc：送信元の IP アドレス
  - IPdst：送信先の IP アドレス
    （IPsrc > IPdst のような形式で表示されます）
- TCP/UDP ヘッダー
  - TCPdst：送信先の TCP ポート番号
  - TCPsrc：送信元の TCP ポート番号
  - TCPflags：TCP の通信のフラグ（SYN なら接続開始）
- ペイロード

## トラフィック監視による攻撃活動の検知

### スキャン活動の検知

- 水平スキャン：あるホストから、LAN 内の様々な IP アドレスに対してパケットを送信してスキャンする
  ある IPsrc から、多様な IPdst に対してのパケットが短時間のうちに観測される

- 垂直スキャン：あるホストから、LAN 内の特定の IP アドレスの様々なポートに対して IP パケットを送信してスキャンする
  ある IPsrc から一部の IPdst に対して多様な TCPdst が短時間に観測される

### DDos 攻撃の検知

**UDP Flood の場合**

- IPsrc が偽装されていない場合の攻撃（スプーフィングされていない攻撃）
  ある IPsrc から、特定の IPdst に対する多数の長い UDP が観測される

- IPsrc が偽装されている場合（スプーフィングされている攻撃）
  組織の範囲外の IPsrc から、特定の IPdst への UDP が観測される

**TCP SYN Flood の場合**

- UDP Flood の TCP 版（UDP と違うのは短い TCP 通信）
  :::message
  しかし、単純にトラフィックボリュームのみで検知しようとすると、クラウドストレージに大きいビデオデータをアップロードしただけで誤検知される可能性がある（これはビデオファイルのアップロードには、高速化のためにマルチスレッドによる大量の TCP コネクションの発生などがあるからだ）
  :::
- パケット数や平均パケット長を見たり、TCP フラグまで見ることができればベスト
- TCP セッション状態も含めて見られれば、LAN 内の特定の IPdst と TCPdst に対するセッション数の急増による検知が可能

**Slow HTTP DoS の場合**

- 小さなパケットによる長時間の TCP セッションが観測される
- ネットワーク層、トランスポート層の監視だけでは`websocket`などの正規通信との識別が難しい

> 以前は Deep Packet Inspection(DPI)と呼ばれるパケットのペイロードを解析する手法によって検知可能であったが、TLS による通信の暗号化によって意味がなくなってしまった

:::details TCP/IP モデルの層と役割
| 層                         | 役割                             | 主要プロトコル             | データ単位              | 検知対象                                |
| -------------------------- | -------------------------------- | -------------------------- | ----------------------- | --------------------------------------- |
| **アプリケーション層**     | ユーザーアプリケーション間の通信 | HTTP, HTTPS, FTP, DNS, SSH | メッセージ              | Web 攻撃、DNS 攻撃、異常なリクエスト    |
| **トランスポート層**       | エンドツーエンド通信の制御       | TCP, UDP                   | セグメント/データグラム | ポートスキャン、DDoS 攻撃               |
| **インターネット層**       | パケットの経路制御               | IP, ICMP                   | パケット                | IP スプーフィング、ネットワークスキャン |
| **ネットワークアクセス層** | 物理的な通信                     | Ethernet, Wi-Fi            | フレーム                | MAC アドレス攻撃、ARP 攻撃              |
:::